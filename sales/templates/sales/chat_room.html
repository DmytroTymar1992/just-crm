{% extends "sales/base-sales.html" %}
{% load static %}

{% block content %}
<div class="chat-container">
  <!-- Ліва колонка: Контакти -->
  <div class="contacts-column">
    <div class="contacts-header">
      <h5 class="mb-0">Контакти</h5>
    </div>
    <div class="contacts-body" id="contacts-container">
      {% include "sales/room_list.html" %}
    </div>
  </div>

  <!-- Центральна колонка: Чат -->
  <div class="chat-column">
    <!-- Заголовок діалогу -->
    <div class="chat-header">
      <div class="chat-title">
        <h5 class="mb-0">
          <span class="contact-name">{{ room.contact.first_name }} {{ room.contact.last_name }}</span>
          {% if room.contact.company %}
            <small class="company-name">{{ room.contact.company.name }}</small>
          {% endif %}
        </h5>
      </div>
      <div class="chat-actions">
        <a href="sip:380501234567" class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-telephone me-1"></i> Подзвонити
        </a>
        <button type="button" class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#taskModal">
          <i class="bi bi-plus-circle me-1"></i> Створити задачу
        </button>
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#emailModal">
          <i class="bi bi-envelope me-1"></i> Написати Email
        </button>
      </div>
    </div>

    <!-- Кнопка "Завантажити ще" -->
    <button id="load-more-btn" class="load-more-btn">
      Завантажити ще
    </button>

    <!-- Лог чату -->
    <div id="chat-log" class="chat-body">
      {% if page_obj %}
        {% include "sales/partials/chat_messages.html" with interactions=page_obj.object_list %}
      {% else %}
        <div class="no-messages">
          Повідомлень ще немає
        </div>
      {% endif %}
    </div>

    <!-- Форма для відправки -->
    <div class="chat-footer">
      <div class="input-group">
        <textarea id="chat-message-input" class="form-control" placeholder="Введіть текст (Telegram)..." rows="1"></textarea>
        <button id="chat-message-submit" class="btn btn-primary">
          <i class="bi bi-send"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Права колонка: Додаткові функції -->
  <div class="sidebar-column">
    <div class="sidebar-header">
      <h5 class="mb-0">Додаткові функції</h5>
    </div>
    <div class="sidebar-body">
      <p class="text-muted">Тут може бути щось інше.</p>
    </div>
  </div>
</div>

<!-- Модальне вікно (для Email) -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary-gradient text-white">
        <h5 class="modal-title">Надіслати Email</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="email-message-input" class="form-control" rows="4" placeholder="Введіть текст листа..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
        <button type="button" class="btn btn-primary" id="email-message-submit">
          <i class="bi bi-envelope me-1"></i> Надіслати
        </button>
        <button type="button" class="btn btn-success" id="email-template-submit">
          <i class="bi bi-envelope-check me-1"></i> Надіслати шаблон листа
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Модальне вікно для створення задачі -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary-gradient text-white">
        <h5 class="modal-title">Створити задачу</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="task-form">
          <div class="mb-3">
            <label for="task-type" class="form-label">Тип задачі</label>
            <select id="task-type" class="form-select" required>
              <option value="call">Дзвінок</option>
              <option value="email">Лист</option>
              <option value="message">Повідомлення</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="task-date" class="form-label">Дата задачі</label>
            <input type="datetime-local" id="task-date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="task-target" class="form-label">Ціль</label>
            <input type="text" id="task-target" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="task-description" class="form-label">Опис</label>
            <textarea id="task-description" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
        <button type="button" class="btn btn-primary" id="task-submit">
          <i class="bi bi-plus-circle me-1"></i> Створити
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Додаємо Google Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  /* Загальний стиль для чату */
  .chat-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); /* Темно-синій градієнт */
    padding: 20px;
    font-family: 'Inter', sans-serif;
    display: flex;
    gap: 20px;
  }

  /* Ліва колонка: Контакти */
  .contacts-column {
    width: 280px;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .contacts-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
    color: white;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 1rem;
    border-radius: 20px 20px 0 0;
  }

  .contacts-body {
    padding: 15px;
    max-height: calc(100vh - 60px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .contacts-body::-webkit-scrollbar {
    width: 6px;
  }

  .contacts-body::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }

  .contacts-body::-webkit-scrollbar-track {
    background: transparent;
  }

  /* Центральна колонка: Чат */
  .chat-column {
    flex-grow: 1;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .chat-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 20px 20px 0 0;
  }

  .chat-title h5 {
    margin: 0;
    font-weight: 600;
  }

  .contact-name {
    color: white;
    font-size: 1.2rem;
  }

  .company-name {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    display: block;
  }

  .chat-actions .btn {
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .chat-actions .btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: white;
  }

  .load-more-btn {
    display: none;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: none;
    border-radius: 0;
    font-size: 0.9rem;
    transition: background 0.3s ease;
  }

  .load-more-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .chat-body {
    flex-grow: 1;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .chat-body::-webkit-scrollbar {
    width: 6px;
  }

  .chat-body::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }

  .chat-body::-webkit-scrollbar-track {
    background: transparent;
  }

  .no-messages {
    color: rgba(255, 255, 255, 0.5);
    text-align: center;
    padding: 20px;
    font-size: 1rem;
  }

  /* Повідомлення */
  .chat-body .mb-3 {
    margin-bottom: 15px !important;
  }

  .chat-body .rounded-3 {
    border-radius: 12px !important;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }

  .chat-body .justify-content-start .rounded-3 {
    background: rgba(255, 255, 255, 0.9);
    border-left: 4px solid #3b82f6;
  }

  .chat-body .justify-content-end .rounded-3 {
    background: #3b82f6;
    color: white;
    border-right: 4px solid #60a5fa;
  }

  .chat-body .text-primary {
    color: #3b82f6 !important;
  }

  .chat-body .text-success {
    color: #10b981 !important;
  }

  .chat-body .bg-warning-subtle {
    background: rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px;
    padding: 8px;
  }

  .chat-body .text-dark {
    color: #1e3a8a !important;
  }

  .chat-body .text-muted {
    color: rgba(255, 255, 255, 0.7) !important;
  }

  /* Форма для відправки */
  .chat-footer {
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0 0 20px 20px;
  }

  .input-group {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  #chat-message-input {
    border: none;
    resize: none;
    min-height: 48px;
    max-height: 150px;
    background: transparent;
    color: #1e3a8a;
    font-size: 0.95rem;
    padding: 12px 15px;
    transition: all 0.3s ease;
  }

  #chat-message-input:focus {
    box-shadow: none;
    outline: none;
  }

  #chat-message-submit {
    border-radius: 0 12px 12px 0;
    background: #3b82f6;
    border: none;
    padding: 0 20px;
    transition: background 0.3s ease;
  }

  #chat-message-submit:hover {
    background: #60a5fa;
  }

  /* Права колонка: Додаткові функції */
  .sidebar-column {
    width: 350px;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .sidebar-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
    color: white;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 1rem;
    border-radius: 20px 20px 0 0;
  }

  .sidebar-body {
    padding: 15px;
    max-height: calc(100vh - 60px);
    overflow-y: auto;
    color: rgba(255, 255, 255, 0.8);
  }

  /* Модальні вікна */
  .modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    border-radius: 16px 16px 0 0;
  }

  .modal-footer {
    border-top: none;
  }

  .form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #d1d5db;
    transition: border-color 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  const currentUser = "{{ request.user.username }}";
  const roomId = "{{ room_id }}";
  const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/sales/' + roomId + '/');

  const chatUrl = `/sales/${roomId}/`;
  const contactFirstName = "{{ room.contact.first_name|escapejs }}";
  const contactLastName = "{{ room.contact.last_name|default:''|escapejs }}";
  const contactFullName = `${contactFirstName} ${contactLastName}`.trim() || "Контакт";

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const username = data.username || 'User';
    const payload = data.payload || {};
    handleIncomingPayload(username, payload);
  };

  chatSocket.onclose = function(e) {
    console.error('WebSocket закрито', e);
  };

  function handleIncomingPayload(username, payload) {
    const msgType = payload.msg_type || '';
    if (msgType === 'email') renderEmailMessage(payload);
    else if (msgType === 'telegram') renderTelegramMessage(payload);
    else if (msgType === 'call') renderCallMessage(payload);
    else renderUnknownMessage(payload);
  }

  document.querySelector('#chat-message-submit').onclick = sendTelegram;

  document.querySelector('#chat-message-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      sendTelegram();
    }
  });

  function sendTelegram() {
    const textarea = document.querySelector('#chat-message-input');
    const message = textarea.value.trim();
    if (!message) return;
    chatSocket.send(JSON.stringify({ 'message': message, 'channel_type': 'telegram' }));
    textarea.value = '';
    textarea.style.height = 'auto';
  }

  document.querySelector('#email-message-submit').onclick = sendEmail;
  function sendEmail() {
    const input = document.querySelector('#email-message-input');
    const message = input.value.trim();
    if (!message) return;
    chatSocket.send(JSON.stringify({ 'message': message, 'channel_type': 'email' }));
    bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
    input.value = '';
  }

  function renderEmailMessage(payload) {
    const tpl = document.getElementById('emailMessageTpl').innerHTML;
    let html = tpl
      .replace('__SUBJECT__', payload.subject || '')
      .replace('__BODY__', (payload.body || "").replace(/\n/g, "<br>"))
      .replace('__TIME__', payload.created_at || '')
      .replace('__SENDER_CLASS__', payload.sender_type === 'contact' ? 'justify-content-start' : 'justify-content-end')
      .replace('__BG_COLOR__', payload.sender_type === 'contact' ? 'rgba(255, 255, 255, 0.9)' : '#3b82f6')
      .replace('__BORDER__', payload.sender_type === 'contact' ? 'border-left: 4px solid #3b82f6' : 'border-right: 4px solid #60a5fa')
      .replace('__ALIGN__', payload.sender_type === 'contact' ? 'text-end' : 'text-start');
    appendMessage(html);

    if (payload.sender_type === 'contact') {
      const notificationContent = `
        <strong>Email від ${contactFullName}</strong><br>
        <strong>Тема:</strong> ${payload.subject || ''}<br>
        <p class="message-text">${payload.body || ''}</p>
        <small>${payload.created_at || ''}</small>
      `;
      showNotification('email', notificationContent);
    }
  }

  function renderTelegramMessage(payload) {
    const tpl = document.getElementById('telegramMessageTpl').innerHTML;
    let html = tpl
      .replace('__BODY__', (payload.body || "").replace(/\n/g, "<br>"))
      .replace('__TIME__', payload.created_at || '')
      .replace('__SENDER_CLASS__', payload.sender_type === 'contact' ? 'justify-content-start' : 'justify-content-end')
      .replace('__BG_COLOR__', payload.sender_type === 'contact' ? 'rgba(255, 255, 255, 0.9)' : '#3b82f6')
      .replace('__BORDER__', payload.sender_type === 'contact' ? 'border-left: 4px solid #3b82f6' : 'border-right: 4px solid #60a5fa')
      .replace('__ALIGN__', payload.sender_type === 'contact' ? 'text-end' : 'text-start');
    appendMessage(html);

    if (payload.sender_type === 'contact') {
      const notificationContent = `
        <strong>Telegram від ${contactFullName}</strong><br>
        <p class="message-text">${payload.body || ''}</p>
        <small>${payload.created_at || ''}</small>
      `;
      showNotification('telegram', notificationContent);
    }
  }

  function renderCallMessage(payload) {
    const tpl = document.getElementById('callMessageTpl').innerHTML;
    let html = tpl
      .replace('__IS_INCOMING__', payload.sender_type === 'contact' ? '(Вхідний)' : '(Вихідний)')
      .replace('__CLIENT_PHONE__', payload.client_phone || '')
      .replace('__DIAL_AT__', payload.dial_at || '')
      .replace('__BRIDGE_AT__', payload.bridge_at || '')
      .replace('__HANGUP_AT__', payload.hangup_at || '')
      .replace('__TIME__', payload.created_at || '')
      .replace('__SENDER_CLASS__', payload.sender_type === 'contact' ? 'justify-content-start' : 'justify-content-end')
      .replace('__ALIGN__', payload.sender_type === 'contact' ? 'text-end' : 'text-start');
    appendMessage(html);

    if (payload.sender_type === 'contact') {
      const notificationContent = `
        <strong>[CALL] (Вхідний) від ${contactFullName}</strong><br>
        <p class="message-text">Телефон: ${payload.client_phone || ''}</p>
        <small>${payload.created_at || ''}</small>
      `;
      showNotification('call', notificationContent);
    }
  }

  function renderUnknownMessage(payload) {
    const chatLog = document.getElementById('chat-log');
    const wrapper = document.createElement('div');
    wrapper.classList.add('mb-3', 'd-flex', 'justify-content-end');
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('p-3', 'rounded-3', 'shadow-sm', 'bg-warning', 'text-dark');
    msgDiv.style.maxWidth = '70%';
    msgDiv.innerHTML = `UNKNOWN type message: <pre>${JSON.stringify(payload, null, 2)}</pre>`;
    wrapper.appendChild(msgDiv);
    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendMessage(html) {
    const chatLog = document.getElementById('chat-log');
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  document.addEventListener("DOMContentLoaded", function() {
    const chatLog = document.getElementById("chat-log");
    if (chatLog) chatLog.scrollTop = chatLog.scrollHeight;
  });

  const loadMoreBtn = document.getElementById('load-more-btn');
  if (hasPrevious) {
    loadMoreBtn.style.display = 'block';
  }

  loadMoreBtn.addEventListener('click', function() {
    loadOlderMessages();
  });

  function loadOlderMessages() {
    if (!prevPageNumber) return;

    const url = `/sales/{{ room_id }}/load_more_interactions/?page=${prevPageNumber}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        const chatLog = document.getElementById('chat-log');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data.messages_html;
        chatLog.insertBefore(tempDiv, chatLog.firstChild);

        hasPrevious = data.has_previous;
        prevPageNumber = hasPrevious ? data.prev_page_number : null;

        if (!hasPrevious) {
          loadMoreBtn.style.display = 'none';
        }
      })
      .catch(err => console.error("Помилка при завантаженні старіших повідомлень:", err));
  }

  document.querySelector('#email-template-submit').onclick = sendEmailTemplate;

  function sendEmailTemplate() {
    const subject = document.querySelector('#email-subject-input')?.value || 'Ласкаво просимо!';
    chatSocket.send(JSON.stringify({ 'message': '', 'subject': subject, 'channel_type': 'email_template' }));
    bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
  }

  document.querySelector('#chat-message-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = `${this.scrollHeight}px`;
  });

  document.querySelector('#task-submit').onclick = createTask;

  function createTask() {
    const taskType = document.querySelector('#task-type').value;
    const taskDate = document.querySelector('#task-date').value;
    const taskTarget = document.querySelector('#task-target').value;
    const taskDescription = document.querySelector('#task-description').value;

    if (!taskType || !taskDate || !taskTarget) {
      alert('Будь ласка, заповніть усі обов’язкові поля!');
      return;
    }

    fetch('/sales/create_task/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({
        room_id: roomId,
        task_type: taskType,
        task_date: taskDate,
        target: taskTarget,
        description: taskDescription,
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Задачу створено!');
        bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        document.querySelector('#task-form').reset();
      } else {
        alert('Помилка: ' + data.error);
      }
    })
    .catch(err => console.error('Помилка при створенні задачі:', err));
  }

  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }
</script>

{% if page_obj %}
  <script>
    let currentPage = {{ page_obj.number }};
    let hasPrevious = {{ page_obj.has_previous|yesno:"true,false" }};
    let prevPageNumber = hasPrevious ? (currentPage - 1) : null;
  </script>
{% else %}
  <script>
    let currentPage = 1;
    let hasPrevious = false;
    let prevPageNumber = null;
  </script>
{% endif %}

<script type="text/x-template" id="emailMessageTpl">
  <div class="mb-3 d-flex __SENDER_CLASS__">
    <div class="p-3 rounded-3 shadow-sm" style="max-width: 70%; background: __BG_COLOR__; __BORDER__;">
      <div class="text-success fw-semibold mb-1">Email</div>
      <div class="bg-warning-subtle p-2 rounded mb-2"><strong>Тема:</strong> __SUBJECT__</div>
      <p class="text-dark mb-0">__BODY__</p>
      <small class="text-muted d-block __ALIGN__ mt-2">__TIME__</small>
    </div>
  </div>
</script>

<script type="text/x-template" id="telegramMessageTpl">
  <div class="mb-3 d-flex __SENDER_CLASS__">
    <div class="p-3 rounded-3 shadow-sm" style="max-width: 70%; background: __BG_COLOR__; __BORDER__;">
      <div class="text-primary fw-semibold mb-1">Telegram</div>
      <p class="text-dark mb-0">__BODY__</p>
      <small class="text-muted d-block __ALIGN__ mt-2">__TIME__</small>
    </div>
  </div>
</script>

<script type="text/x-template" id="callMessageTpl">
  <div class="mb-3 d-flex __SENDER_CLASS__">
    <div class="p-3 rounded-3 shadow-sm bg-info text-white" style="max-width: 70%;">
      <div class="fw-semibold">[CALL] __IS_INCOMING__</div>
      <div class="mt-1">
        Телефон клієнта: __CLIENT_PHONE__<br>
        Початок: __DIAL_AT__<br>
        Підняття слухавки: __BRIDGE_AT__<br>
        Завершення: __HANGUP_AT__
      </div>
      <small class="d-block __ALIGN__ mt-2">__TIME__</small>
    </div>
  </div>
</script>
{% endblock %}