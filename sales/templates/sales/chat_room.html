{% extends "sales/base-sales.html" %}
{% load static %}
{% block content %}
<div class="d-flex h-100">
  <!-- Ліва колонка: Контакти -->
  <div class="d-flex flex-column h-100 shadow-sm" style="width: 250px; flex-shrink: 0; background: #ffffff;">
    <div class="p-3 border-bottom bg-primary text-white">
      <h5 class="mb-0 fw-bold">Контакти</h5>
    </div>
    <div class="flex-grow-1 overflow-auto" id="contacts-container">
      {% include "sales/partials/room_list.html" %}
    </div>
  </div>

  <!-- Центральна колонка: Чат -->
  <div class="d-flex flex-column flex-grow-1">
    <!-- Заголовок діалогу -->
    <div class="p-3 border-bottom bg-white shadow-sm d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <span class="fw-bold text-dark">{{ room.contact.first_name }} {{ room.contact.last_name }}</span>
        {% if room.contact.company %}
          <a href="{% url 'company_detail' room.contact.company.id %}">
          <small class="text-muted d-block">{{ room.contact.company.name }}</small>
          </a>
        {% endif %}
      </h5>
        <a href="sip:{{room.contact.phone}}">Подзвонити</a>
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#taskModal">
          <i class="bi bi-plus-circle me-1"></i> Створити задачу
        </button>
      <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#emailModal">
        <i class="bi bi-envelope me-1"></i> Написати Email
      </button>
    </div>

    <!-- Кнопка "Завантажити ще" (старіші повідомлення) -->
    <button id="load-more-btn"
            class="btn btn-outline-secondary btn-sm w-100 text-center border-0"
            style="display: none; border-radius: 0;"
    >
      Завантажити ще
    </button>

    <!-- Лог чату -->
    <div id="chat-log" class="flex-grow-1 overflow-auto p-3" style="background: #f8f9fa;">
        {% if page_obj %}
      {% include "sales/partials/chat_messages.html" with interactions=page_obj.object_list %}
        {% else %}
        <div class="p-3 text-muted">
        Повідомлень ще немає
      </div>
        {% endif %}
    </div>

    <!-- Форма для відправки -->
    <div class="p-3 bg-white border-top shadow-sm">
  <div class="input-group">
    <textarea id="chat-message-input" class="form-control" placeholder="Введіть текст (Telegram)..." rows="1"></textarea>
    <button id="chat-message-submit" class="btn btn-primary" type="button">
      <i class="bi bi-send me-1"></i> Надіслати
    </button>
  </div>
</div>
  </div>


  <!-- Права колонка: Вакансії компанії -->
  <div class="d-flex flex-column h-100 shadow-sm" style="width: 350px; flex-shrink: 0; background: #ffffff;">
    <div class="p-3 border-bottom bg-primary text-white">
      <h5 class="mb-0 fw-bold">Вакансії на Work</h5>
    </div>
    <div class="p-3 flex-grow-1 overflow-auto" id="vacancies-container">
      <div id="vacancies-list" class="list-group">
        <!-- Вакансії завантажуватимуться асинхронно -->
        <div class="text-center py-3">
          <i class="bi bi-arrow-clockwise spin" style="font-size: 1.5rem;"></i>
          <p class="text-muted mt-2">Завантаження вакансій...</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% include "sales/partials/email_modal.html" %}
{% include "sales/partials/task_modal.html" %}
{% endblock %}

{% block extra_css %}
<style>
  #chat-log, #contacts-container {
    background: #f8f9fa;
  }
  #chat-log::-webkit-scrollbar, #contacts-container::-webkit-scrollbar {
    width: 6px;
  }
  #chat-log::-webkit-scrollbar-thumb, #contacts-container::-webkit-scrollbar-thumb {
    background-color: #ced4da;
    border-radius: 3px;
  }
  #chat-log::-webkit-scrollbar-track, #contacts-container::-webkit-scrollbar-track {
    background: #e9ecef;
  }
  #chat-message-input {
  resize: vertical; /* Дозволяє змінювати висоту, але не ширину */
  min-height: 40px; /* Мінімальна висота */
  max-height: 150px; /* Максимальна висота */
  overflow-y: auto; /* Додає прокрутку, якщо текст перевищує max-height */
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'sales/js/chat/chat_main.js' %}"></script>
<script src="{% static 'sales/js/chat/chat_messages.js' %}"></script>
<script src="{% static 'sales/js/chat/vacancies.js' %}"></script>
<script src="{% static 'sales/js/chat/tasks.js' %}"></script>

<!-- Додаємо початкові значення для load_more.js -->
<script>
  window.chatData = {
    currentUser: "{{ request.user.username|escapejs }}",
    roomId: "{{ room_id|escapejs }}",
    contactFirstName: "{{ room.contact.first_name|escapejs }}",
    contactLastName: "{{ room.contact.last_name|default:''|escapejs }}",
    currentPage: {{ page_obj.number|default:1 }},
    hasPrevious: {{ page_obj.has_previous|yesno:"true,false"|default:"false" }}
  };
  window.chatData.contactFullName = `${window.chatData.contactFirstName} ${window.chatData.contactLastName}`.trim() || "Контакт";
</script>
<script src="{% static 'sales/js/chat/load_more.js' %}"></script>
<script src="{% static 'sales/js/chat/utils.js' %}"></script>
{% include "sales/partials/message_templates.html" %}
{% endblock %}