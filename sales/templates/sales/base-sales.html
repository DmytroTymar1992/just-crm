{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Just CRM | {% block title %}Базова сторінка{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'main/css/sales.css' %}">
  <style>
    body { height: 100vh; overflow: hidden; background: #f5f6f8; }
    .container-fluid { height: 100%; padding: 0; }
    .sidebar { height: 100vh; position: fixed; top: 0; left: 0; width: 70px; background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%); transition: width 0.3s ease; z-index: 1000; }
    .sidebar:hover { width: 200px; }
    .sidebar .nav-link { color: #bdc3c7; padding: 15px 0; text-align: center; white-space: nowrap; transition: color 0.2s ease, background 0.2s ease; }
    .sidebar .nav-link:hover { color: #ffffff; background: rgba(255, 255, 255, 0.1); }
    .sidebar .nav-link img { width: 28px; height: 28px; filter: invert(80%); }
    .sidebar .nav-link:hover img { filter: invert(100%); }
    .sidebar .nav-link div { display: none; margin-top: 5px; font-size: 0.85rem; }
    .sidebar:hover .nav-link div { display: block; }
    .main-content { margin-left: 70px; height: 100vh; max-width: calc(100vw - 70px); overflow-y: auto; overflow-x: hidden; transition: margin-left 0.3s ease, max-width 0.3s ease; }
    .sidebar:hover ~ .main-content { margin-left: 200px; max-width: calc(100vw - 200px); }
    .notification { min-width: 300px; max-width: 400px; margin-bottom: 10px; cursor: pointer; opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; }
    .notification.show { opacity: 1; transform: translateY(0); }
    .notification:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  <div class="container-fluid">
    <div class="row g-0">
      <nav class="sidebar">
        <div class="position-sticky pt-4">
          <ul class="nav flex-column text-center">
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'company_list' %}" title="Компанії"><img src="{% static 'main/images/companies.svg' %}" alt="Компанії"><div>Компанії</div></a></li>
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'contact_list' %}" title="Контакти"><img src="{% static 'main/images/contacts.svg' %}" alt="Контакти"><div>Контакти</div></a></li>
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'chat_room' room_id=1 %}" title="Робочий процес"><img src="{% static 'main/images/workflow.svg' %}" alt="Робочий процес"><div>Робочий процес</div></a></li>
          </ul>
        </div>
      </nav>
      <main class="main-content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <div id="notification-container" class="position-fixed bottom-0 start-0 p-3" style="z-index: 1050;"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const currentRoomId = "{{ room_id|default_if_none:'' }}";
    let chatSocket = null;

    // Ініціалізуємо WebSocket тільки якщо room_id визначено
    if (currentRoomId) {
      chatSocket = new WebSocket('ws://' + window.location.host + '/ws/sales/' + currentRoomId + '/');

      chatSocket.onopen = function() {
        console.log('Chat WebSocket connection opened for room:', currentRoomId);
      };

      chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Отримані дані від /ws/sales/:', data);
        const payload = data.payload || {};

        // Перевіряємо, чи повідомлення з іншої кімнати
        if (payload.room_id && payload.room_id !== currentRoomId) {
          showNotification(
            payload.room_id,
            payload.sender_name || data.username || 'Невідомий',
            payload.company_name || '',
            payload.body || payload.message || 'Нове повідомлення',
            payload.msg_type || 'telegram'
          );
        }
      };

      chatSocket.onclose = function(e) {
        console.log('Chat socket closed unexpectedly:', e);
      };

      chatSocket.onerror = function(e) {
        console.error('Chat socket error:', e);
      };
    }

    function showNotification(roomId, senderName, companyName, message, msgType) {
      console.log('Показуємо сповіщення:', {roomId, senderName, companyName, message, msgType});
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.classList.add('notification', 'alert', 'shadow');

      // Колір залежно від типу повідомлення
      notification.classList.add(
        msgType === 'telegram' ? 'alert-primary' :
        msgType === 'email' ? 'alert-success' :
        'alert-info'
      );

      const content = `
        <h6 class="alert-heading mb-1">${senderName}</h6>
        ${companyName ? `<small class="d-block text-muted mb-1">${companyName}</small>` : ''}
        <p class="mb-0 text-truncate">${message}</p>
      `;
      notification.innerHTML = content;

      notification.addEventListener('click', () => {
        window.open(`/sales/${roomId}/`, '_blank');
        notification.remove();
      });

      container.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 10);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 10000);
    }

    // Залишаємо логіку для списку кімнат (якщо вона потрібна)
    const roomListSocket = new WebSocket('ws://' + window.location.host + '/ws/rooms/');
    roomListSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      if (data.type === 'room_list') {
        updateRoomListUI(data.rooms);
      }
    };

    function updateRoomListUI(rooms) {
      const roomListUl = document.getElementById("room-list");
      if (!roomListUl) return;
      roomListUl.innerHTML = "";
      if (rooms.length === 0) {
        let li = document.createElement("li");
        li.classList.add("list-group-item", "text-muted", "text-center", "py-3", "border-0");
        li.textContent = "Немає листів";
        roomListUl.appendChild(li);
        return;
      }
      rooms.forEach(r => {
        let li = document.createElement("li");
        li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center", "px-3", "py-2", "border-bottom");
        let a = document.createElement("a");
        a.href = `/sales/${r.room_id}/`;
        a.classList.add("text-decoration-none", "text-dark", "d-flex", "flex-column");
        if (r.room_id == currentRoomId) {
          li.classList.add("bg-primary-subtle");
          a.classList.add("fw-semibold");
        }
        let div = document.createElement("div");
        if (r.company_name) {
          let small = document.createElement("small");
          small.classList.add("text-muted");
          small.textContent = r.company_name;
          div.appendChild(small);
          let br = document.createElement("br");
          div.appendChild(br);
        }
        let span = document.createElement("span");
        span.textContent = `${r.first_name} ${r.last_name || ''}`;
        div.appendChild(span);
        a.appendChild(div);
        li.appendChild(a);
        if (r.unread_count > 0) {
          let badge = document.createElement("span");
          badge.classList.add("badge", "bg-primary", "rounded-pill");
          badge.textContent = r.unread_count;
          li.appendChild(badge);
        }
        roomListUl.appendChild(li);
      });
    }
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>