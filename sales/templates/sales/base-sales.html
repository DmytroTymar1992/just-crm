{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Just CRM | {% block title %}Базова сторінка{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'main/css/sales.css' %}">
  <style>
    body { height: 100vh; overflow: hidden; background: #f5f6f8; }
    .container-fluid { height: 100%; padding: 0; }
    .sidebar { height: 100vh; position: fixed; top: 0; left: 0; width: 70px; background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%); transition: width 0.3s ease; z-index: 1000; }
    .sidebar:hover { width: 200px; }
    .sidebar .nav-link { color: #bdc3c7; padding: 15px 0; text-align: center; white-space: nowrap; transition: color 0.2s ease, background 0.2s ease; }
    .sidebar .nav-link:hover { color: #ffffff; background: rgba(255, 255, 255, 0.1); }
    .sidebar .nav-link img { width: 28px; height: 28px; filter: invert(80%); }
    .sidebar .nav-link:hover img { filter: invert(100%); }
    .sidebar .nav-link div { display: none; margin-top: 5px; font-size: 0.85rem; }
    .sidebar:hover .nav-link div { display: block; }
    .main-content { margin-left: 70px; height: 100vh; max-width: calc(100vw - 70px); overflow-y: auto; overflow-x: hidden; transition: margin-left 0.3s ease, max-width 0.3s ease; }
    .sidebar:hover ~ .main-content { margin-left: 200px; max-width: calc(100vw - 200px); }
    .notification { min-width: 300px; max-width: 400px; margin-bottom: 10px; cursor: pointer; opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; }
    .notification.show { opacity: 1; transform: translateY(0); }
    .notification:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  <div class="container-fluid">
    <div class="row g-0">
      <nav class="sidebar">
        <div class="position-sticky pt-4">
          <ul class="nav flex-column text-center">
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'company_list' %}" title="Компанії"><img src="{% static 'main/images/companies.svg' %}" alt="Компанії"><div>Компанії</div></a></li>
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'contact_list' %}" title="Контакти"><img src="{% static 'main/images/contacts.svg' %}" alt="Контакти"><div>Контакти</div></a></li>
            <li class="nav-item mb-4"><a class="nav-link" href="{% url 'chat_room' room_id=1 %}" title="Робочий процес"><img src="{% static 'main/images/workflow.svg' %}" alt="Робочий процес"><div>Робочий процес</div></a></li>
          </ul>
        </div>
      </nav>
      <main class="main-content">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <div id="notification-container" class="position-fixed bottom-0 start-0 p-3" style="z-index: 1050;"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const currentRoomId = "{{ room_id|default_if_none:'' }}";
    let chatSocket = null;

    if (currentRoomId) {
      chatSocket = new WebSocket('ws://' + window.location.host + '/ws/sales/' + currentRoomId + '/');

      chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const username = data.username || 'User';
        const payload = data.payload || {};
        handleIncomingPayload(username, payload);
      };

      chatSocket.onclose = function(e) {
        console.error('WebSocket закрито', e);
      };
    }

    function handleIncomingPayload(username, payload) {
      // Додаємо room_id до payload, якщо його немає
      if (!payload.room_id) {
        payload.room_id = currentRoomId; // Припускаємо, що сервер не додає room_id
      }

      // Якщо room_id не збігається з поточним, показуємо сповіщення
      if (payload.room_id && payload.room_id !== currentRoomId) {
        const msgType = payload.msg_type || '';
        if (msgType === 'email') renderEmailNotification(payload);
        else if (msgType === 'telegram') renderTelegramNotification(payload);
        else renderUnknownNotification(payload);
      }
    }

    function renderEmailNotification(payload) {
      const tpl = document.getElementById('emailNotificationTpl').innerHTML;
      let html = tpl
        .replace('__SUBJECT__', payload.subject || '')
        .replace('__BODY__', (payload.body || "").replace(/\n/g, "<br>"))
        .replace('__TIME__', payload.created_at || '')
        .replace('__SENDER_CLASS__', payload.sender_type === 'contact' ? 'justify-content-start' : 'justify-content-end')
        .replace('__BG_COLOR__', payload.sender_type === 'contact' ? '#ffffff' : '#e9f7ef')
        .replace('__BORDER__', payload.sender_type === 'contact' ? 'border-left: 4px solid #28a745' : 'border-right: 4px solid #28a745')
        .replace('__ALIGN__', payload.sender_type === 'contact' ? 'text-end' : 'text-start');
      appendNotification(html, payload.room_id);
    }

    function renderTelegramNotification(payload) {
      const tpl = document.getElementById('telegramNotificationTpl').innerHTML;
      let html = tpl
        .replace('__BODY__', (payload.body || "").replace(/\n/g, "<br>"))
        .replace('__TIME__', payload.created_at || '')
        .replace('__SENDER_CLASS__', payload.sender_type === 'contact' ? 'justify-content-start' : 'justify-content-end')
        .replace('__BG_COLOR__', payload.sender_type === 'contact' ? '#ffffff' : '#e6f0fa')
        .replace('__BORDER__', payload.sender_type === 'contact' ? 'border-left: 4px solid #007bff' : 'border-right: 4px solid #007bff')
        .replace('__ALIGN__', payload.sender_type === 'contact' ? 'text-end' : 'text-start');
      appendNotification(html, payload.room_id);
    }

    function renderUnknownNotification(payload) {
      const container = document.getElementById('notification-container');
      const wrapper = document.createElement('div');
      wrapper.classList.add('notification', 'mb-3', 'd-flex', 'justify-content-end');
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('p-3', 'rounded-3', 'shadow-sm', 'bg-warning', 'text-dark');
      msgDiv.style.maxWidth = '70%';
      msgDiv.innerHTML = `UNKNOWN type message: <pre>${JSON.stringify(payload, null, 2)}</pre>`;
      wrapper.appendChild(msgDiv);
      appendNotification(wrapper.outerHTML, payload.room_id);
    }

    function appendNotification(html, roomId) {
      const container = document.getElementById('notification-container');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const notification = wrapper.firstChild;

      notification.addEventListener('click', () => {
        window.open(`/sales/${roomId}/`, '_blank');
        notification.remove();
      });

      container.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 10);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 10000);
    }
  </script>

  <!-- Шаблони для сповіщень, скопійовані з чату -->
  <script type="text/x-template" id="emailNotificationTpl">
    <div class="notification mb-3 d-flex __SENDER_CLASS__">
      <div class="p-3 rounded-3 shadow-sm" style="max-width: 70%; background: __BG_COLOR__; __BORDER__;">
        <div class="text-success fw-semibold mb-1">Email</div>
        <div class="bg-warning-subtle p-2 rounded mb-2"><strong>Тема:</strong> __SUBJECT__</div>
        <p class="text-dark mb-0">__BODY__</p>
        <small class="text-muted d-block __ALIGN__ mt-2">__TIME__</small>
      </div>
    </div>
  </script>

  <script type="text/x-template" id="telegramNotificationTpl">
    <div class="notification mb-3 d-flex __SENDER_CLASS__">
      <div class="p-3 rounded-3 shadow-sm" style="max-width: 70%; background: __BG_COLOR__; __BORDER__;">
        <div class="text-primary fw-semibold mb-1">Telegram</div>
        <p class="text-dark mb-0">__BODY__</p>
        <small class="text-muted d-block __ALIGN__ mt-2">__TIME__</small>
      </div>
    </div>
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>