{# sales/partials/chat_messages.html #}
{% for item in interactions %}
  {% ifchanged item.created_at.date %}
    {% if not forloop.first %}
      </div> <!-- Закриваємо попередній блок дня -->
    {% endif %}
    <div class="chat-day-group">
      <div class="text-center my-4">
        <span class="badge bg-dark-subtle text-dark rounded-pill px-4 py-2 fw-medium" style="font-size: 0.9rem;">
          {{ item.created_at|date:"d.m.Y" }}
        </span>
      </div>
  {% endifchanged %}

  {% if item.interaction_type == "email" %}
    {% if item.sender == "contact" %}
      <div class="mb-4 d-flex justify-content-start">
        <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #ffffff, #f8f9fa); border-left: 5px solid #00cc66;">
          <div class="text-success fw-semibold mb-2" style="font-size: 0.95rem;">Email</div>
          <div class="bg-warning-subtle p-2 rounded-3 mb-2" style="font-size: 0.9rem;">
            <strong>Тема:</strong> {{ item.email_message.subject }}
          </div>
          <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.email_message.body|linebreaks }}</p>
          <small class="text-muted d-block text-end mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% else %}
      <div class="mb-4 d-flex justify-content-end">
        <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #e9f7ef, #d4edda); border-right: 5px solid #00cc66;">
          <div class="text-success fw-semibold mb-2" style="font-size: 0.95rem;">Email</div>
          <div class="bg-warning-subtle p-2 rounded-3 mb-2" style="font-size: 0.9rem;">
            <strong>Тема:</strong> {{ item.email_message.subject }}
          </div>
          <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.email_message.body|linebreaks }}</p>
          <small class="text-muted d-block mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% endif %}
  {% elif item.interaction_type == "telegram" %}
    {% if item.sender == "contact" %}
      <div class="mb-4 d-flex justify-content-start">
        <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #ffffff, #f1f3f5); border-left: 5px solid #3399ff;">
          <div class="text-primary fw-semibold mb-2" style="font-size: 0.95rem;">Telegram</div>
          <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.telegram_message.text|default_if_none:"(немає тексту)"|linebreaks }}</p>
          <small class="text-muted d-block text-end mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% else %}
      <div class="mb-4 d-flex justify-content-end">
        <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #e6f0fa, #d6e4f0); border-right: 5px solid #3399ff;">
          <div class="text-primary fw-semibold mb-2" style="font-size: 0.95rem;">Telegram</div>
          <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.telegram_message.text|default_if_none:"(немає тексту)"|linebreaks }}</p>
          <small class="text-muted d-block mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% endif %}
  {% elif item.interaction_type == "call" %}
    {% if item.sender == "contact" %}
      <div class="mb-4 d-flex justify-content-start">
        <div class="p-3 rounded-4 shadow-sm bg-info-subtle text-dark" style="max-width: 70%;">
          <div class="fw-semibold" style="font-size: 0.95rem;">
            {% if item.call_message.bridge_at %}
              Дзвінок тривав - {{ item.call_message.duration|floatformat:0 }} сек
            {% else %}
              Пропущено
            {% endif %}
          </div>
          <div class="mt-2">
            <div class="call-description mt-2" style="font-size: 0.9rem;">
              {% if item.call_message.description %}
                <p class="mb-0">{{ item.call_message.description|linebreaks }}</p>
                <span class="edit-description text-warning cursor-pointer ms-2" data-interaction-id="{{ item.id }}" title="Редагувати опис">✏️</span>
              {% else %}
                <span class="add-description text-success cursor-pointer ms-2" data-interaction-id="{{ item.id }}" title="Додати опис">+</span>
              {% endif %}
              <div class="description-form mt-3" style="display: none;">
                <textarea class="form-control rounded-3" rows="2" placeholder="Додати опис дзвінка" style="font-size: 0.9rem;">{{ item.call_message.description|default_if_none:"" }}</textarea>
                <button class="btn btn-sm btn-primary mt-2 save-call-description rounded-pill px-3" data-interaction-id="{{ item.id }}">Зберегти</button>
                <button class="btn btn-sm btn-outline-secondary mt-2 cancel-edit rounded-pill px-3">Скасувати</button>
              </div>
            </div>
          </div>
          <small class="d-block text-end mt-2 text-muted" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% else %}
      <div class="mb-4 d-flex justify-content-end">
        <div class="p-3 rounded-4 shadow-sm bg-info-subtle text-dark" style="max-width: 70%;">
          <div class="fw-semibold" style="font-size: 0.95rem;">
            {% if item.call_message.bridge_at %}
              Дзвінок тривав - {{ item.call_message.duration|floatformat:0 }} сек
            {% else %}
              Скасований виклик
            {% endif %}
          </div>
          <div class="mt-2">
            <div class="call-description mt-2" style="font-size: 0.9rem;">
              {% if item.call_message.description %}
                <p class="mb-0">{{ item.call_message.description|linebreaks }}</p>
                <span class="edit-description text-warning cursor-pointer ms-2" data-interaction-id="{{ item.id }}" title="Редагувати опис">✏️</span>
              {% else %}
                <span class="add-description text-success cursor-pointer ms-2" data-interaction-id="{{ item.id }}" title="Додати опис">+</span>
              {% endif %}
              <div class="description-form mt-3" style="display: none;">
                <textarea class="form-control rounded-3" rows="2" placeholder="Додати опис дзвінка" style="font-size: 0.9rem;">{{ item.call_message.description|default_if_none:"" }}</textarea>
                <button class="btn btn-sm btn-primary mt-2 save-call-description rounded-pill px-3" data-interaction-id="{{ item.id }}">Зберегти</button>
                <button class="btn btn-sm btn-outline-secondary mt-2 cancel-edit rounded-pill px-3">Скасувати</button>
              </div>
            </div>
          </div>
          <small class="d-block mt-2 text-muted" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% endif %}
  {% elif item.interaction_type == "chat" %}
    {% if item.is_system %}
      <div class="mb-4 d-flex justify-content-center">
        <div class="p-2 rounded-4 shadow-sm text-center" style="max-width: 70%; background: #fff3cd; border: 2px solid #ffaa00; color: #704f18;">
          <p class="mb-0 fw-semibold" style="font-size: 0.9rem;">{{ item.content|default_if_none:"(немає тексту)"|linebreaks }}</p>
          <small class="d-block mt-1 text-muted" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% else %}
      {% if item.sender == "contact" %}
        <div class="mb-4 d-flex justify-content-start">
          <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #ffffff, #f1f3f5); border-left: 5px solid #6c757d;">
            <div class="text-secondary fw-semibold mb-2" style="font-size: 0.95rem;">Chat</div>
            <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.content|default_if_none:"(немає тексту)"|linebreaks }}</p>
            <small class="text-muted d-block text-end mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
          </div>
        </div>
      {% else %}
        <div class="mb-4 d-flex justify-content-end">
          <div class="p-3 rounded-4 shadow-sm" style="max-width: 70%; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-right: 5px solid #6c757d;">
            <div class="text-secondary fw-semibold mb-2" style="font-size: 0.95rem;">Chat</div>
            <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.5;">{{ item.content|default_if_none:"(немає тексту)"|linebreaks }}</p>
            <small class="text-muted d-block mt-2" style="font-size: 0.8rem;">{{ item.created_at|date:"H:i" }}</small>
          </div>
        </div>
      {% endif %}
    {% endif %}
  {% endif %}
{% if forloop.last %}
  </div> <!-- Закриваємо останній блок дня -->
{% endif %}
{% endfor %}