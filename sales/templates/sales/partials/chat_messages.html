{# sales/partials/chat_messages.html #}

{% comment %}
  Додайте цей блок CSS у ваш основний CSS файл або в тег <style> на сторінці.
  Переконайтесь, що Font Awesome підключено (наприклад, через CDN).
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endcomment %}

<style>

</style>

<div class="chat-container"> {# Додано загальний контейнер #}
{% for item in interactions %}
  {% ifchanged item.created_at.date %}
    {% if not forloop.first %}
      </div> {% endif %}
    <div class="chat-day-group">
      <div class="chat-date-separator">
        <span>{{ item.created_at|date:"d F Y" }}</span> {# Більш читабельний формат дати #}
      </div>
  {% endifchanged %}

  {% with interaction_type=item.interaction_type sender_class=item.sender|yesno:"message-in,message-out" %}

  {# --- Email --- #}
  {% if interaction_type == "email" %}
    <div class="message {{ sender_class }} message-email">
      <div class="message-content">
        <div class="message-header">
          <i class="fas fa-envelope"></i>
          <span class="message-type">Email</span>
        </div>
        {% if item.email_message.subject %}
        <div class="message-subject">
          <strong>Тема:</strong> {{ item.email_message.subject }}
        </div>
        {% endif %}
        <p class="message-body mb-0">{{ item.email_message.body|linebreaks }}</p>
        <small class="message-timestamp text-muted">{{ item.created_at|date:"H:i" }}</small>
      </div>
    </div>

  {# --- Telegram --- #}
  {% elif interaction_type == "telegram" %}
    <div class="message {{ sender_class }} message-telegram">
      <div class="message-content">
        <div class="message-header">
          <i class="fab fa-telegram-plane"></i>
          <span class="message-type">Telegram</span>
        </div>
        <p class="message-body mb-0">{{ item.telegram_message.text|default_if_none:"(no text)"|linebreaks }}</p>
        <small class="message-timestamp text-muted">{{ item.created_at|date:"H:i" }}</small>
      </div>
    </div>

  {# --- Call --- #}
  {% elif interaction_type == "call" %}
    <div class="message {{ sender_class }} message-call">
      <div class="message-content">
        <div class="message-header">
          <i class="fas fa-phone-alt"></i>
          <span class="message-type">
            {% if item.sender == "contact" %}
                {% if item.call_message.bridge_at %}Вхідний дзвінок{% else %}Пропущений{% endif %}
            {% else %}
                {% if item.call_message.bridge_at %}Вихідний дзвінок{% else %}Скасований виклик{% endif %}
            {% endif %}
          </span>
        </div>
        <div class="message-body">
            {% if item.call_message.bridge_at %}
                <span class="d-block mb-1"><i class="fas fa-clock me-1"></i> Тривалість: {{ item.call_message.duration|floatformat:0 }} сек</span>
            {% endif %}

          <div class="call-description">
            {% if item.call_message.description %}
              <p class="mb-1">{{ item.call_message.description|linebreaks }}</p>
              <span class="edit-description text-warning cursor-pointer" data-interaction-id="{{ item.id }}" title="Редагувати опис"><i class="fas fa-pencil-alt"></i></span>
            {% else %}
              <span class="add-description text-success cursor-pointer" data-interaction-id="{{ item.id }}" title="Додати опис"><i class="fas fa-plus-circle"></i> Додати опис</span>
            {% endif %}
            <div class="description-form mt-2" style="display: none;">
              <textarea class="form-control form-control-sm" rows="2" placeholder="Додати опис дзвінка">{{ item.call_message.description|default_if_none:"" }}</textarea>
              <button class="btn btn-sm btn-primary mt-1 save-call-description" data-interaction-id="{{ item.id }}"><i class="fas fa-save me-1"></i>Зберегти</button>
              <button class="btn btn-sm btn-secondary mt-1 cancel-edit"><i class="fas fa-times me-1"></i>Скасувати</button>
            </div>
          </div>
        </div>
        <small class="message-timestamp text-muted">{{ item.created_at|date:"H:i" }}</small>
      </div>
    </div>

  {# --- Chat / System --- #}
  {% elif interaction_type == "chat" %}
    {% if item.is_system %}
      <div class="message message-system">
         <div class="message-content">
            <div class="message-header justify-content-center"> {# Центруємо заголовок системного повідомлення #}
                <i class="fas fa-info-circle"></i>
                <span class="message-type ms-1">Системне повідомлення</span>
            </div>
            <p class="message-body mb-0">{{ item.content|default_if_none:"(no text)"|linebreaks }}</p>
            <small class="message-timestamp">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% else %}
      <div class="message {{ sender_class }} message-chat">
        <div class="message-content">
           <div class="message-header">
               <i class="fas fa-comments"></i>
               <span class="message-type">Chat</span>
           </div>
          <p class="message-body mb-0">{{ item.content|default_if_none:"(no text)"|linebreaks }}</p>
          <small class="message-timestamp text-muted">{{ item.created_at|date:"H:i" }}</small>
        </div>
      </div>
    {% endif %}
  {% endif %}
  {% endwith %}

{% if forloop.last %}
  </div> {% endif %}
{% endfor %}
</div> {# Закриваємо chat-container #}