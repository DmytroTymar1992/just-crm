{% extends 'sales/base-sales.html' %}
{% load static %}

{% block title %}
  Об'єднання контактів
{% endblock %}

{% block content %}
<div class="d-flex flex-column h-100">
  <div class="p-4 flex-shrink-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold text-dark mb-0 me-3">Об'єднання контактів</h1>
      <div class="input-group shadow-sm me-3 flex-grow-1" style="max-width: 400px;">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input type="text" id="contact-search" class="form-control border-start-0" placeholder="Пошук за ім'ям, прізвищем, телефоном, email тощо">
      </div>
    </div>
    <p class="text-muted">Виберіть два контакти для об'єднання та вкажіть, який залишити основним.</p>
  </div>
  <div id="contacts-container" class="flex-grow-1 overflow-auto px-4 pb-4">
    <form id="merge-contacts-form" method="post" action="{% url 'merge_contacts' %}">
      {% csrf_token %}
      <div class="row g-3" id="contacts-list">
        {% for contact in contacts %}
          <div class="col-12 col-md-6 col-lg-4 contact-card" data-contact-id="{{ contact.id }}">
            <div class="card h-100 shadow-sm border-0 modern-contact-card">
              <div class="card-header bg-light border-bottom d-flex align-items-center p-3">
                <div class="avatar-circle me-3">
                  <i class="bi bi-person-fill text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-semibold contact-name">
                    <input type="checkbox" name="selected_contacts" value="{{ contact.id }}" class="contact-checkbox me-2">
                    {{ contact.first_name }} {{ contact.last_name|default_if_none:"" }}
                  </h6>
                  {% if contact.position %}
                    <small class="text-muted d-block">{{ contact.position }}</small>
                  {% endif %}
                </div>
              </div>
              <div class="card-body p-3">
                <div class="contact-details">
                  {% if contact.company %}
                    <p class="mb-2 text-muted small">
                      <i class="bi bi-building me-2"></i>{{ contact.company.name }}
                    </p>
                  {% endif %}
                  {% if contact.phone %}
                    <p class="mb-2 text-muted small">
                      <i class="bi bi-telephone-fill me-2"></i>{{ contact.phone }}
                    </p>
                  {% endif %}
                  {% if contact.email %}
                    <p class="mb-2 text-muted small">
                      <i class="bi bi-envelope-fill me-2"></i>{{ contact.email }}
                    </p>
                  {% endif %}
                  {% if contact.telegram_username or contact.telegram_id %}
                    <p class="mb-2 text-muted small">
                      <i class="bi bi-telegram me-2"></i>
                      {% if contact.telegram_username %}
                        @{{ contact.telegram_username }}
                      {% else %}
                        ID: {{ contact.telegram_id }}
                      {% endif %}
                    </p>
                  {% endif %}
                </div>
              </div>
              <div class="card-footer bg-light border-top d-flex justify-content-between align-items-center p-2">
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i> {{ contact.created_at }}
                </small>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12 text-center py-5">
            <i class="bi bi-person-lines-fill text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">Немає жодного контакту</p>
          </div>
        {% endfor %}
      </div>
      <div class="mt-4">
        <label class="fw-semibold">Який контакт залишити основним?</label>
        <div id="primary-contact-selection" class="mt-2" style="display: none;">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="keep_contact" id="keep_contact1" value="" disabled>
            <label class="form-check-label" for="keep_contact1" id="label_keep_contact1"></label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="keep_contact" id="keep_contact2" value="" disabled>
            <label class="form-check-label" for="keep_contact2" id="label_keep_contact2"></label>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <button type="submit" class="btn btn-primary shadow-sm" id="merge-submit-btn" disabled>
          <i class="bi bi-link-45deg me-1"></i> Об'єднати контакти
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Використовуємо ті самі стилі, що й у списку контактів */
  #contacts-container {
    background: #f8f9fa;
  }
  #contacts-container::-webkit-scrollbar {
    width: 6px;
  }
  #contacts-container::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 3px;
  }
  #contacts-container::-webkit-scrollbar-track {
    background: #e9ecef;
  }

  .modern-contact-card {
    border-radius: 12px;
    background: #f9fbfd;
    border: 1px solid #d8dee5;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    overflow: hidden;
  }
  .modern-contact-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 14px 36px rgba(0, 0, 0, 0.14);
  }

  .card-header {
    background: linear-gradient(135deg, #e8eef5 0%, #d9e2ec 100%);
    border-bottom: 1px solid #d1d9e2;
  }
  .avatar-circle {
    width: 40px;
    height: 40px;
    background: #dbe7ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  .contact-name {
    color: #212529;
    font-weight: 600;
  }

  .card-body {
    padding: 1rem 1.5rem;
    background: #f9fbfd;
  }
  .contact-details p {
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
  }
  .contact-details i {
    width: 20px;
    text-align: center;
    color: #6c757d;
  }

  .card-footer {
    background: #f5f7fa;
    border-top: 1px solid #d8dee5;
    font-size: 0.8rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  }

  .contact-checkbox {
    cursor: pointer;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("contact-search");
    const contactsList = document.getElementById("contacts-list");
    const mergeForm = document.getElementById("merge-contacts-form");
    const primarySelection = document.getElementById("primary-contact-selection");
    const keepContact1 = document.getElementById("keep_contact1");
    const keepContact2 = document.get mous.getElementById("keep_contact2");
    const labelKeepContact1 = document.getElementById("label_keep_contact1");
    const labelKeepContact2 = document.getElementById("label_keep_contact2");
    const mergeSubmitBtn = document.getElementById("merge-submit-btn");

    let selectedContacts = [];

    // Пошук контактів
    if (searchInput) {
      let debounceTimer;
      searchInput.addEventListener("input", function(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = e.target.value.trim();
          searchContacts(query);
        }, 300);
      });
    }

    function searchContacts(query) {
      contactsList.innerHTML = '<div class="text-center py-5"><i class="bi bi-arrow-clockwise spin" style="font-size: 2rem;"></i><p class="text-muted">Завантаження...</p></div>';
      fetch(`/sales/contacts/search/?q=${encodeURIComponent(query)}`, {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateContactsList(data.contacts);
        } else {
          contactsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">Помилка при пошуку</p></div>';
        }
      })
      .catch(error => {
        console.error("Помилка:", error);
        contactsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">Щось пішло не так</p></div>';
      });
    }

    function updateContactsList(contacts) {
      contactsList.innerHTML = "";
      if (contacts.length === 0) {
        contactsList.innerHTML = '<div class="col-12 text-center py-5"><i class="bi bi-person-lines-fill text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Контактів не знайдено</p></div>';
        return;
      }

      contacts.forEach(contact => {
        const cardHtml = `
          <div class="col-12 col-md-6 col-lg-4 contact-card" data-contact-id="${contact.id}">
            <div class="card h-100 shadow-sm border-0 modern-contact-card">
              <div class="card-header bg-light border-bottom d-flex align-items-center p-3">
                <div class="avatar-circle me-3">
                  <i class="bi bi-person-fill text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-semibold contact-name">
                    <input type="checkbox" name="selected_contacts" value="${contact.id}" class="contact-checkbox me-2">
                    ${contact.first_name} ${contact.last_name || ''}
                  </h6>
                  ${contact.position ? `<small class="text-muted d-block">${contact.position}</small>` : ''}
                </div>
              </div>
              <div class="card-body p-3">
                <div class="contact-details">
                  ${contact.company_name ? `<p class="mb-2 text-muted small"><i class="bi bi-building me-2"></i>${contact.company_name}</p>` : ''}
                  ${contact.phone ? `<p class="mb-2 text-muted small"><i class="bi bi-telephone-fill me-2"></i>${contact.phone}</p>` : ''}
                  ${contact.email ? `<p class="mb-2 text-muted small"><i class="bi bi-envelope-fill me-2"></i>${contact.email}</p>` : ''}
                  ${contact.telegram_username || contact.telegram_id ? `
                    <p class="mb-2 text-muted small">
                      <i class="bi bi-telegram me-2"></i>
                      ${contact.telegram_username ? `@${contact.telegram_username}` : `ID: ${contact.telegram_id}`}
                    </p>` : ''}
                </div>
              </div>
              <div class="card-footer bg-light border-top d-flex justify-content-between align-items-center p-2">
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i> ${contact.created_at}
                </small>
              </div>
            </div>
          </div>
        `;
        contactsList.insertAdjacentHTML('beforeend', cardHtml);
      });

      bindCheckboxes();
    }

    function bindCheckboxes() {
      document.querySelectorAll(".contact-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", function() {
          const contactId = this.value;
          if (this.checked) {
            if (selectedContacts.length < 2) {
              selectedContacts.push(contactId);
            } else {
              this.checked = false;
            }
          } else {
            selectedContacts = selectedContacts.filter(id => id !== contactId);
          }
          updatePrimarySelection();
        });
      });
    }

    function updatePrimarySelection() {
      if (selectedContacts.length === 2) {
        primarySelection.style.display = "block";
        mergeSubmitBtn.disabled = false;

        const contact1Card = document.querySelector(`.contact-card[data-contact-id="${selectedContacts[0]}"]`);
        const contact2Card = document.querySelector(`.contact-card[data-contact-id="${selectedContacts[1]}"]`);
        const contact1Name = contact1Card.querySelector(".contact-name").textContent.trim();
        const contact2Name = contact2Card.querySelector(".contact-name").textContent.trim();

        keepContact1.value = selectedContacts[0];
        keepContact2.value = selectedContacts[1];
        labelKeepContact1.textContent = contact1Name;
        labelKeepContact2.textContent = contact2Name;
        keepContact1.disabled = false;
        keepContact2.disabled = false;
        keepContact1.checked = true; // За замовчуванням вибираємо перший
      } else {
        primarySelection.style.display = "none";
        mergeSubmitBtn.disabled = true;
        keepContact1.disabled = true;
        keepContact2.disabled = true;
        keepContact1.checked = false;
        keepContact2.checked = false;
      }
    }

    mergeForm.addEventListener("submit", function(e) {
      if (selectedContacts.length !== 2) {
        e.preventDefault();
        alert("Виберіть рівно два контакти для об'єднання.");
      }
    });
  });
</script>
{% endblock %}