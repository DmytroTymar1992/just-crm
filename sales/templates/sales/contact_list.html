{% extends 'sales/base-sales.html' %}
{% load static %}

{% block title %}
  Список контактів
{% endblock %}

{% block content %}
<div class="d-flex flex-column h-100">
  <div class="p-4 flex-shrink-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold text-dark mb-0 me-3">Список контактів</h1>
      <div class="input-group shadow-sm me-3 flex-grow-1" style="max-width: 400px;">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input type="text" id="contact-search" class="form-control border-start-0" placeholder="Пошук за ім'ям, прізвищем, телефоном чи компанією">
      </div>
      <a href="#" class="btn btn-primary shadow-sm" id="add-contact-btn" data-contact-id="0">
          <i class="bi bi-person-plus-fill me-1"></i> Додати контакт
      </a>
    </div>
  </div>
  <div id="contacts-container" class="flex-grow-1 overflow-auto px-4 pb-4">
    <div class="row g-3" id="contacts-list">
      {% for contact in contacts %}
        <div class="col-12 col-md-6 col-lg-4 contact-card" data-contact-id="{{ contact.id }}">
          <div class="card shadow-sm border-0 h-100 transition-hover">
            <div class="card-body p-3">
              <div class="d-flex align-items-center mb-2">
                <div class="flex-shrink-0 me-3">
                  <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-semibold">
                    <a href="#" class="text-dark text-decoration-none contact-name">{{ contact.first_name }} {{ contact.last_name|default_if_none:"" }}</a>
                  </h6>
                  {% if contact.position %}
                    <small class="text-muted">{{ contact.position }}</small>
                  {% endif %}
                </div>
                <!-- Іконка редагування -->
                <div class="flex-shrink-0">
                  <button class="btn btn-link p-0 text-muted edit-contact-btn" data-bs-toggle="modal" data-bs-target="#editContactModal" data-contact-id="{{ contact.id }}">
                    <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                  </button>
                </div>
              </div>
              <div class="contact-details">
                {% if contact.company %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-building me-1"></i>
                    <a href="#" class="text-muted text-decoration-none">{{ contact.company.name }}</a>
                  </p>
                {% endif %}
                {% if contact.phone %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-telephone-fill me-1"></i> {{ contact.phone }}
                  </p>
                {% endif %}
                {% if contact.email %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-envelope-fill me-1"></i>
                    <a href="mailto:{{ contact.email }}" class="text-muted text-decoration-none">{{ contact.email }}</a>
                  </p>
                {% endif %}
                {% if contact.telegram_username or contact.telegram_id %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-telegram me-1"></i>
                    {% if contact.telegram_username %}
                      <a href="https://t.me/{{ contact.telegram_username }}" class="text-muted text-decoration-none" target="_blank">@{{ contact.telegram_username }}</a>
                    {% else %}
                      ID: {{ contact.telegram_id }}
                    {% endif %}
                  </p>
                {% endif %}
                <small class="text-muted d-block mt-2">
                  <i class="bi bi-clock me-1"></i> Створено: {{ contact.created_at|date:"d.m.Y H:i" }}
                </small>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-12 text-center py-5">
          <i class="bi bi-person-lines-fill text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-3">Немає жодного контакту</p>
        </div>
      {% endfor %}
    </div>
    <!-- Пагінація -->
    <div id="pagination-container">
      {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
                  <span aria-hidden="true">«</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">«</span>
              </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
              </li>
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
                  <span aria-hidden="true">»</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">»</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Модальне вікно для редагування контакту -->
<div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editContactModalLabel">Редагувати контакт</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="edit-contact-form" method="post" action="{% url 'edit_contact' 0 %}" data-contact-id="0">
        {% csrf_token %}
        <div class="modal-body">
          <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
          <div class="mb-3">
            <label for="first_name" class="form-label">Ім'я</label>
            <input type="text" class="form-control" id="first_name" name="first_name" required>
          </div>
          <div class="mb-3">
            <label for="last_name" class="form-label">Прізвище</label>
            <input type="text" class="form-control" id="last_name" name="last_name">
          </div>
          <div class="mb-3">
            <label for="position" class="form-label">Посада</label>
            <input type="text" class="form-control" id="position" name="position">
          </div>
          <div class="mb-3 position-relative">
            <label for="company" class="form-label">Компанія</label>
            <input type="text" class="form-control" id="company-search" placeholder="Пошук компанії...">
            <select class="form-select" id="company" name="company" style="display: none;">
              <option value="">— Без компанії —</option>
              {% for company in companies %}
                <option value="{{ company.id }}" data-name="{{ company.name }}">{{ company.name }}</option>
              {% endfor %}
            </select>
            <div id="company-suggestions" class="dropdown-menu w-100 shadow-sm" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Телефон</label>
            <input type="text" class="form-control" id="phone" name="phone">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email">
          </div>
          <div class="mb-3">
            <label for="telegram_username" class="form-label">Telegram Username</label>
            <input type="text" class="form-control" id="telegram_username" name="telegram_username">
          </div>
          <div class="mb-3">
            <label for="telegram_id" class="form-label">Telegram ID</label>
            <input type="number" class="form-control" id="telegram_id" name="telegram_id">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-primary" id="save-contact-changes">Зберегти зміни</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Контейнер контактів */
  #contacts-container {
    background: #f5f6f8;
  }
  #contacts-container::-webkit-scrollbar {
    width: 6px;
  }
  #contacts-container::-webkit-scrollbar-thumb {
    background-color: #ced4da;
    border-radius: 3px;
  }
  #contacts-container::-webkit-scrollbar-track {
    background: #e9ecef;
  }

  /* Пошук */
  #contact-search {
    border-radius: 0 0.375rem 0.375rem 0;
  }

  /* Картки */
  .card {
    border-radius: 10px;
    background: #ffffff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
  }
  .contact-name:hover {
    color: #007bff !important;
  }
  .contact-details p {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .contact-details .text-muted a {
    color: #6c757d;
  }
  .contact-details .text-muted a:hover {
    color: #007bff;
  }

  /* Іконка редагування */
  .edit-contact-btn {
    color: #adb5bd;
    transition: color 0.2s ease, transform 0.2s ease;
  }
  .edit-contact-btn:hover {
    color: #007bff;
    transform: scale(1.1);
  }

  /* Кнопка */
  .btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  }

  /* Telegram іконка */
  .bi-telegram {
    color: #0088cc;
  }
  .bi-telegram:hover {
    color: #00aced;
  }

  /* Пагінація */
  .pagination .page-link {
    color: #007bff;
    border: none;
    padding: 8px 12px;
    transition: background 0.2s ease, color 0.2s ease;
  }
  .pagination .page-link:hover {
    background: #f8f9fa;
    color: #0056b3;
  }
  .pagination .page-item.active .page-link {
    background: #007bff;
    color: #ffffff;
  }
  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    background: transparent;
  }

  /* Пошук компанії */
  #company-suggestions {
    border: none;
    border-top: 1px solid #ced4da;
    border-radius: 0 0 8px 8px;
    background: #ffffff;
    padding: 0;
  }
  #company-suggestions .dropdown-item {
    padding: 8px 12px;
    font-size: 0.9rem;
    color: #495057;
    transition: background 0.2s ease;
  }
  #company-suggestions .dropdown-item:hover {
    background: #f8f9fa;
    color: #007bff;
  }
  #company-suggestions.show {
    display: block;
  }
</style>
{% endblock %}


{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("contacts-container");
    const searchInput = document.getElementById("contact-search");
    const contactsList = document.getElementById("contacts-list");

    // Якщо є контейнер, прокрутимо вниз
    if (container) {
      container.scrollTop = container.scrollHeight;
    }

    // -------- Пошук контактів через AJAX --------
    if (searchInput) {
      let debounceTimer;
      searchInput.addEventListener("input", function(e) {
        clearTimeout(debounceTimer); // Очищаємо попередній таймер
        debounceTimer = setTimeout(() => {
          const query = e.target.value.trim();
          searchContacts(query);
        }, 300); // Затримка 300 мс для зменшення кількості запитів
      });
    }

    function searchContacts(query) {
      // Показуємо лоадер (опціонально)
      contactsList.innerHTML = '<div class="text-center py-5"><i class="bi bi-arrow-clockwise spin" style="font-size: 2rem;"></i><p class="text-muted">Завантаження...</p></div>';

      fetch(`/sales/contacts/search/?q=${encodeURIComponent(query)}`, {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest" // Щоб Django розпізнав AJAX
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateContactsList(data.contacts);
          updatePagination(data.pagination); // Оновлюємо пагінацію, якщо потрібно
        } else {
          contactsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">Помилка при пошуку</p></div>';
        }
      })
      .catch(error => {
        console.error("Помилка:", error);
        contactsList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">Щось пішло не так</p></div>';
      });
    }

    // -------- Оновлення списку контактів --------
    function updateContactsList(contacts) {
      contactsList.innerHTML = ""; // Очищаємо поточний список
      if (contacts.length === 0) {
        contactsList.innerHTML = '<div class="col-12 text-center py-5"><i class="bi bi-person-lines-fill text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Контактів не знайдено</p></div>';
        return;
      }

      contacts.forEach(contact => {
        const cardHtml = `
          <div class="col-12 col-md-6 col-lg-4 contact-card" data-contact-id="${contact.id}" data-name="${contact.first_name} ${contact.last_name || ''}" data-phone="${contact.phone || ''}" data-company="${contact.company_name || ''}">
            <div class="card shadow-sm border-0 h-100 transition-hover">
              <div class="card-body p-3">
                <div class="d-flex align-items-center mb-2">
                  <div class="flex-shrink-0 me-3">
                    <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-0 fw-semibold">
                      <a href="#" class="text-dark text-decoration-none contact-name">${contact.first_name} ${contact.last_name || ''}</a>
                    </h6>
                    ${contact.position ? `<small class="text-muted">${contact.position}</small>` : ''}
                  </div>
                  <div class="flex-shrink-0">
                    <button class="btn btn-link p-0 text-muted edit-contact-btn" data-bs-toggle="modal" data-bs-target="#editContactModal" data-contact-id="${contact.id}">
                      <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                    </button>
                  </div>
                </div>
                <div class="contact-details">
                  ${contact.company_name ? `<p class="mb-1 text-muted small"><i class="bi bi-building me-1"></i><a href="#" class="text-muted text-decoration-none">${contact.company_name}</a></p>` : ''}
                  ${contact.phone ? `<p class="mb-1 text-muted small"><i class="bi bi-telephone-fill me-1"></i>${contact.phone}</p>` : ''}
                  ${contact.email ? `<p class="mb-1 text-muted small"><i class="bi bi-envelope-fill me-1"></i><a href="mailto:${contact.email}" class="text-muted text-decoration-none">${contact.email}</a></p>` : ''}
                  ${contact.telegram_username ? `<p class="mb-1 text-muted small"><i class="bi bi-telegram me-1"></i><a href="https://t.me/${contact.telegram_username}" class="text-muted text-decoration-none" target="_blank">@${contact.telegram_username}</a></p>` :
                    contact.telegram_id ? `<p class="mb-1 text-muted small"><i class="bi bi-telegram me-1"></i>ID: ${contact.telegram_id}</p>` : ''}
                  <small class="text-muted d-block mt-2">
                    <i class="bi bi-clock me-1"></i> Створено: ${contact.created_at}
                  </small>
                </div>
              </div>
            </div>
          </div>
        `;
        contactsList.insertAdjacentHTML('beforeend', cardHtml);
      });

      // Повторно прив'язуємо обробники для кнопок редагування
      bindEditButtons();
    }

    // -------- Оновлення пагінації (опціонально) --------
    function updatePagination(pagination) {
      const paginationContainer = document.querySelector(".pagination");
      if (!paginationContainer || !pagination.has_other_pages) {
        paginationContainer.style.display = "none";
        return;
      }

      let paginationHtml = "";
      if (pagination.has_previous) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="?page=${pagination.previous_page_number}&q=${encodeURIComponent(searchInput.value)}" data-page="${pagination.previous_page_number}">«</a></li>`;
      } else {
        paginationHtml += `<li class="page-item disabled"><span class="page-link">«</span></li>`;
      }

      pagination.page_range.forEach(page => {
        paginationHtml += `
          <li class="page-item ${pagination.current_page === page ? 'active' : ''}">
            <a class="page-link" href="?page=${page}&q=${encodeURIComponent(searchInput.value)}" data-page="${page}">${page}</a>
          </li>`;
      });

      if (pagination.has_next) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="?page=${pagination.next_page_number}&q=${encodeURIComponent(searchInput.value)}" data-page="${pagination.next_page_number}">»</a></li>`;
      } else {
        paginationHtml += `<li class="page-item disabled"><span class="page-link">»</span></li>`;
      }

      paginationContainer.innerHTML = paginationHtml;
      bindPaginationLinks();
    }

    // -------- Прив'язка обробників для пагінації --------
    function bindPaginationLinks() {
      document.querySelectorAll(".pagination .page-link").forEach(link => {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          const page = this.dataset.page;
          if (page) {
            searchContactsWithPage(searchInput.value, page);
          }
        });
      });
    }

    function searchContactsWithPage(query, page) {
      fetch(`/sales/contacts/search/?q=${encodeURIComponent(query)}&page=${page}`, {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateContactsList(data.contacts);
          updatePagination(data.pagination);
        }
      })
      .catch(error => console.error("Помилка:", error));
    }

    // Решта вашого коду (редагування, додавання контактів тощо) залишається без змін
    // Але додамо функцію для повторної прив'язки кнопок редагування:
    function bindEditButtons() {
      document.querySelectorAll(".edit-contact-btn").forEach(button => {
        button.addEventListener("click", function() {
          const contactId = this.dataset.contactId;
          const card = this.closest(".contact-card");
          // Ваш код для редагування (залишається як є)
        });
      });
    }

    // Ініціально прив'язуємо кнопки редагування
    bindEditButtons();
  });
</script>
{% endblock %}

