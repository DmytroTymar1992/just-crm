{% extends 'sales/base-sales.html' %}
{% load static %}

{% block title %}
  Список контактів
{% endblock %}

{% block content %}
<div class="d-flex flex-column h-100">
  <div class="p-4 flex-shrink-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold text-dark mb-0 me-3">Список контактів</h1>
      <div class="input-group shadow-sm me-3 flex-grow-1" style="max-width: 400px;">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input type="text" id="contact-search" class="form-control border-start-0" placeholder="Пошук за ім'ям, прізвищем, телефоном чи компанією">
      </div>
      <a href="#" class="btn btn-primary shadow-sm" id="add-contact-btn" data-contact-id="0">
          <i class="bi bi-person-plus-fill me-1"></i> Додати контакт
      </a>
    </div>
  </div>
  <div id="contacts-container" class="flex-grow-1 overflow-auto px-4 pb-4">
    <div class="row g-3" id="contacts-list">
      {% for contact in contacts %}
        <div class="col-12 col-md-6 col-lg-4 contact-card" data-contact-id="{{ contact.id }}">
          <div class="card shadow-sm border-0 h-100 transition-hover">
            <div class="card-body p-3">
              <div class="d-flex align-items-center mb-2">
                <div class="flex-shrink-0 me-3">
                  <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-semibold">
                    <a href="#" class="text-dark text-decoration-none contact-name">{{ contact.first_name }} {{ contact.last_name|default_if_none:"" }}</a>
                  </h6>
                  {% if contact.position %}
                    <small class="text-muted">{{ contact.position }}</small>
                  {% endif %}
                </div>
                <!-- Іконка редагування -->
                <div class="flex-shrink-0">
                  <button class="btn btn-link p-0 text-muted edit-contact-btn" data-bs-toggle="modal" data-bs-target="#editContactModal" data-contact-id="{{ contact.id }}">
                    <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                  </button>
                </div>
              </div>
              <div class="contact-details">
                {% if contact.company %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-building me-1"></i>
                    <a href="#" class="text-muted text-decoration-none">{{ contact.company.name }}</a>
                  </p>
                {% endif %}
                {% if contact.phone %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-telephone-fill me-1"></i> {{ contact.phone }}
                  </p>
                {% endif %}
                {% if contact.email %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-envelope-fill me-1"></i>
                    <a href="mailto:{{ contact.email }}" class="text-muted text-decoration-none">{{ contact.email }}</a>
                  </p>
                {% endif %}
                {% if contact.telegram_username or contact.telegram_id %}
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-telegram me-1"></i>
                    {% if contact.telegram_username %}
                      <a href="https://t.me/{{ contact.telegram_username }}" class="text-muted text-decoration-none" target="_blank">@{{ contact.telegram_username }}</a>
                    {% else %}
                      ID: {{ contact.telegram_id }}
                    {% endif %}
                  </p>
                {% endif %}
                <small class="text-muted d-block mt-2">
                  <i class="bi bi-clock me-1"></i> Створено: {{ contact.created_at|date:"d.m.Y H:i" }}
                </small>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-12 text-center py-5">
          <i class="bi bi-person-lines-fill text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-3">Немає жодного контакту</p>
        </div>
      {% endfor %}
    </div>
    <!-- Пагінація -->
    <div id="pagination-container">
      {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
                  <span aria-hidden="true">«</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">«</span>
              </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
              </li>
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
                  <span aria-hidden="true">»</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">»</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Модальне вікно для редагування контакту -->
<div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editContactModalLabel">Редагувати контакт</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="edit-contact-form" method="post" action="{% url 'edit_contact' 0 %}" data-contact-id="0">
        {% csrf_token %}
        <div class="modal-body">
          <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
          <div class="mb-3">
            <label for="first_name" class="form-label">Ім'я</label>
            <input type="text" class="form-control" id="first_name" name="first_name" required>
          </div>
          <div class="mb-3">
            <label for="last_name" class="form-label">Прізвище</label>
            <input type="text" class="form-control" id="last_name" name="last_name">
          </div>
          <div class="mb-3">
            <label for="position" class="form-label">Посада</label>
            <input type="text" class="form-control" id="position" name="position">
          </div>
          <div class="mb-3 position-relative">
            <label for="company" class="form-label">Компанія</label>
            <input type="text" class="form-control" id="company-search" placeholder="Пошук компанії...">
            <select class="form-select" id="company" name="company" style="display: none;">
              <option value="">— Без компанії —</option>
              {% for company in companies %}
                <option value="{{ company.id }}" data-name="{{ company.name }}">{{ company.name }}</option>
              {% endfor %}
            </select>
            <div id="company-suggestions" class="dropdown-menu w-100 shadow-sm" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Телефон</label>
            <input type="text" class="form-control" id="phone" name="phone">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email">
          </div>
          <div class="mb-3">
            <label for="telegram_username" class="form-label">Telegram Username</label>
            <input type="text" class="form-control" id="telegram_username" name="telegram_username">
          </div>
          <div class="mb-3">
            <label for="telegram_id" class="form-label">Telegram ID</label>
            <input type="number" class="form-control" id="telegram_id" name="telegram_id">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-primary" id="save-contact-changes">Зберегти зміни</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Контейнер контактів */
  #contacts-container {
    background: #f5f6f8;
  }
  #contacts-container::-webkit-scrollbar {
    width: 6px;
  }
  #contacts-container::-webkit-scrollbar-thumb {
    background-color: #ced4da;
    border-radius: 3px;
  }
  #contacts-container::-webkit-scrollbar-track {
    background: #e9ecef;
  }

  /* Пошук */
  #contact-search {
    border-radius: 0 0.375rem 0.375rem 0;
  }

  /* Картки */
  .card {
    border-radius: 10px;
    background: #ffffff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
  }
  .contact-name:hover {
    color: #007bff !important;
  }
  .contact-details p {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .contact-details .text-muted a {
    color: #6c757d;
  }
  .contact-details .text-muted a:hover {
    color: #007bff;
  }

  /* Іконка редагування */
  .edit-contact-btn {
    color: #adb5bd;
    transition: color 0.2s ease, transform 0.2s ease;
  }
  .edit-contact-btn:hover {
    color: #007bff;
    transform: scale(1.1);
  }

  /* Кнопка */
  .btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  }

  /* Telegram іконка */
  .bi-telegram {
    color: #0088cc;
  }
  .bi-telegram:hover {
    color: #00aced;
  }

  /* Пагінація */
  .pagination .page-link {
    color: #007bff;
    border: none;
    padding: 8px 12px;
    transition: background 0.2s ease, color 0.2s ease;
  }
  .pagination .page-link:hover {
    background: #f8f9fa;
    color: #0056b3;
  }
  .pagination .page-item.active .page-link {
    background: #007bff;
    color: #ffffff;
  }
  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    background: transparent;
  }

  /* Пошук компанії */
  #company-suggestions {
    border: none;
    border-top: 1px solid #ced4da;
    border-radius: 0 0 8px 8px;
    background: #ffffff;
    padding: 0;
  }
  #company-suggestions .dropdown-item {
    padding: 8px 12px;
    font-size: 0.9rem;
    color: #495057;
    transition: background 0.2s ease;
  }
  #company-suggestions .dropdown-item:hover {
    background: #f8f9fa;
    color: #007bff;
  }
  #company-suggestions.show {
    display: block;
  }
</style>
{% endblock %}

{% block extra_js %}
{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("contacts-container");
    const searchInput = document.getElementById("contact-search");
    const searchIcon = document.querySelector(".input-group-text .bi-search");
    const contactsList = document.getElementById("contacts-list");
    const paginationContainer = document.getElementById("pagination-container");

    // -------- Модалка та форма --------
    const editModal = document.getElementById("editContactModal");
    const editForm = document.getElementById("edit-contact-form");
    const formErrors = document.getElementById("form-errors");

    // Поля для пошуку компанії
    const companySearch = document.getElementById("company-search");
    const companySelect = document.getElementById("company");
    const companySuggestions = document.getElementById("company-suggestions");

    // Якщо є контейнер, прокрутимо вниз
    if (container) {
      container.scrollTop = container.scrollHeight;
    }

    // -------- Дебагування ініціалізації --------
    console.log("searchInput:", searchInput);
    console.log("searchIcon:", searchIcon);
    console.log("contactsList:", contactsList);
    console.log("paginationContainer:", paginationContainer);

    // -------- Debounce для пошуку --------
    let searchTimeout;
    function debounceSearch(query, page) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchContacts(query, page);
      }, 300); // Затримка 300 мс
    }

    // -------- Пошук контактів через AJAX --------
    if (searchInput) {
      // Динамічний пошук після введення (з затримкою)
      searchInput.addEventListener("input", function(e) {
        const query = e.target.value.trim();
        console.log("Input event triggered, query:", query);
        debounceSearch(query);
      });

      // Пошук після натискання Enter
      searchInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          const query = e.target.value.trim();
          console.log("Enter pressed, query:", query);
          searchContacts(query);
        }
      });
    }

    // -------- Пошук після натискання на лупу --------
    if (searchIcon) {
      searchIcon.parentElement.addEventListener("click", function() {
        const query = searchInput.value.trim();
        console.log("Search icon clicked, query:", query);
        searchContacts(query);
      });
    }

    function searchContacts(query, page = 1) {
      const url = new URL(window.location.origin + '/sales/contact_list/');
      if (query) {
        url.searchParams.set('q', query);
      }
      url.searchParams.set('page', page);

      console.log("Sending AJAX request to:", url.toString());

      fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest', // Позначка, що це AJAX-запит
        }
      })
      .then(response => {
        console.log("Response status:", response.status);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log("Received data:", data);
        // Оновлюємо список контактів
        contactsList.innerHTML = data.contacts_html;

        // Оновлюємо пагінацію
        paginationContainer.innerHTML = data.pagination_html;

        // Додаємо обробники для кнопок редагування на нових картках
        addEditButtonListeners();

        // Додаємо обробники для пагінації
        addPaginationListeners(query);
      })
      .catch(err => console.error("Помилка при пошуку контактів:", err));
    }

    // -------- Додаємо обробники для кнопок редагування --------
    function addEditButtonListeners() {
      const editButtons = document.querySelectorAll(".edit-contact-btn");
      console.log("Adding edit button listeners, found buttons:", editButtons.length);
      editButtons.forEach(button => {
        button.addEventListener("click", function() {
          console.log("Edit button clicked, contactId:", this.dataset.contactId);
          const contactId = this.dataset.contactId;
          const card = this.closest(".contact-card");

          // Очищаємо помилки
          if (formErrors) {
            formErrors.style.display = "none";
            formErrors.innerHTML = "";
          }

          // Змінюємо action, наприклад /sales/contacts/edit/5/
          editForm.action = `/sales/contacts/edit/${contactId}/`;
          editForm.dataset.contactId = contactId;

          // Заповнюємо поля
          editForm.querySelector("#first_name").value = card.dataset.name.split(" ")[0] || "";
          editForm.querySelector("#last_name").value = card.dataset.name.split(" ").slice(1).join(" ") || "";

          // Посада
          const positionEl = card.querySelector(".text-muted");
          editForm.querySelector("#position").value = positionEl ? positionEl.textContent : "";

          editForm.querySelector("#phone").value = card.dataset.phone || "";

          // Email
          const emailEl = card.querySelector("a[href^='mailto:']");
          editForm.querySelector("#email").value = emailEl ? emailEl.textContent : "";

          // Telegram
          const telegramUsernameEl = card.querySelector("a[href^='https://t.me/']");
          editForm.querySelector("#telegram_username").value = telegramUsernameEl
            ? telegramUsernameEl.textContent.replace("@", "")
            : "";
          const telegramIdText = Array.from(card.querySelectorAll(".contact-details p")).find(p => p.textContent.includes("ID:"));
          editForm.querySelector("#telegram_id").value = telegramIdText
            ? telegramIdText.textContent.split("ID:")[1].trim()
            : "";

          // Компанія
          const companyName = card.dataset.company || "";
          Array.from(companySelect.options).forEach(option => {
            option.selected = (option.dataset.name === companyName);
          });
          companySearch.value = companyName;

          // Відкрити модалку
          const modalInstance = new bootstrap.Modal(editModal);
          modalInstance.show();
        });
      });
    }

    // -------- Додаємо обробники для пагінації --------
    function addPaginationListeners(query) {
      const paginationLinks = paginationContainer.querySelectorAll(".page-link");
      console.log("Adding pagination listeners, found links:", paginationLinks.length);
      paginationLinks.forEach(link => {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          const href = this.getAttribute("href");
          console.log("Pagination link clicked, href:", href);
          if (href && !this.parentElement.classList.contains("disabled")) {
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const page = urlParams.get('page') || 1;
            searchContacts(query, page);
          }
        });
      });
    }

    // -------- Кнопка "Додати контакт" --------
    const addContactBtn = document.getElementById("add-contact-btn");
    if (addContactBtn) {
      addContactBtn.addEventListener("click", function(e) {
        e.preventDefault();
        console.log("Add contact button clicked");

        // Ставимо action на create_contact
        editForm.action = "/sales/contacts/create/";
        editForm.dataset.contactId = 0;

        // Очищаємо поля форми
        editForm.querySelector("#first_name").value = "";
        editForm.querySelector("#last_name").value = "";
        editForm.querySelector("#position").value = "";
        editForm.querySelector("#phone").value = "";
        editForm.querySelector("#email").value = "";
        editForm.querySelector("#telegram_username").value = "";
        editForm.querySelector("#telegram_id").value = "";

        // Скидаємо компанію
        companySelect.value = "";
        companySearch.value = "";

        // Ховаємо помилки, якщо були
        if (formErrors) {
          formErrors.style.display = "none";
          formErrors.innerHTML = "";
        }

        // Відкриваємо модалку
        const modalInstance = new bootstrap.Modal(editModal);
        modalInstance.show();
      });
    }

    // -------- Пошук компанії --------
    companySearch.addEventListener("input", function(e) {
      const query = e.target.value.toLowerCase().trim();
      companySuggestions.innerHTML = "";
      companySuggestions.classList.remove("show");

      if (query.length > 0) {
        const matches = Array.from(companySelect.options).filter(option => {
          const name = option.dataset.name.toLowerCase();
          return name.includes(query) && option.value !== "";
        });

        matches.forEach(option => {
          const item = document.createElement("div");
          item.classList.add("dropdown-item");
          item.textContent = option.dataset.name;
          item.addEventListener("click", function() {
            companySearch.value = option.dataset.name;
            companySelect.value = option.value;
            companySuggestions.classList.remove("show");
          });
          companySuggestions.appendChild(item);
        });

        if (matches.length > 0) {
          companySuggestions.classList.add("show");
        }
      }
    });

    // Закриття підказок, якщо клік поза ними
    document.addEventListener("click", function(e) {
      if (!companySearch.contains(e.target) && !companySuggestions.contains(e.target)) {
        companySuggestions.classList.remove("show");
      }
    });

    // -------- Сабміт форми (AJAX) --------
    editForm.addEventListener("submit", function(e) {
      e.preventDefault();

      const contactId = this.dataset.contactId; // "0" => створення, >0 => редагування
      console.log("Form submitted, contactId=", contactId);
      console.log("Form action=", this.action);

      fetch(this.action, {
        method: "POST",
        body: new FormData(this),
        headers: {
          "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
        }
      })
      .then(response => {
        console.log("Form submission response status:", response.status);
        if (!response.ok) {
          return response.json().then(data => {
            throw data;
          });
        }
        return response.json();
      })
      .then(data => {
        console.log("Form submission response data:", data);
        if (data.success) {
          if (contactId === "0") {
            addNewContactCard(data);
          } else {
            updateExistingCard(data);
          }
          bootstrap.Modal.getInstance(editModal).hide();
        } else {
          showFormErrors(data.error);
        }
      })
      .catch(errData => {
        if (errData && errData.error) {
          showFormErrors(errData.error);
        } else {
          alert("Сталася помилка при збереженні");
          console.error("Unknown error:", errData);
        }
      });
    });

    // -------- Додаємо нову картку в HTML --------
    function addNewContactCard(data) {
      const newCard = document.createElement("div");
      newCard.classList.add("col-12", "col-md-6", "col-lg-4", "contact-card");
      newCard.dataset.contactId = data.id;
      newCard.dataset.name = `${data.first_name} ${data.last_name || ''}`.trim();
      newCard.dataset.phone = data.phone || '';
      newCard.dataset.company = data.company_name || '';

      newCard.innerHTML = `
        <div class="card shadow-sm border-0 h-100 transition-hover">
          <div class="card-body p-3">
            <div class="d-flex align-items-center mb-2">
              <div class="flex-shrink-0 me-3">
                <i class="bi bi-person-circle text-primary" style="font-size: 2rem;"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 fw-semibold">
                  <a href="#" class="text-dark text-decoration-none contact-name">${data.first_name} ${data.last_name}</a>
                </h6>
                <small class="text-muted">${data.position || ''}</small>
              </div>
              <div class="flex-shrink-0">
                <button class="btn btn-link p-0 text-muted edit-contact-btn" data-bs-toggle="modal"
                        data-bs-target="#editContactModal" data-contact-id="${data.id}">
                  <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                </button>
              </div>
            </div>
            <div class="contact-details">
              ${ data.company_name
                ? `<p class="mb-1 text-muted small"><i class="bi bi-building me-1"></i>
                     <a href="#" class="text-muted text-decoration-none">${data.company_name}</a></p>`
                : ''
              }
              ${ data.phone
                ? `<p class="mb-1 text-muted small">
                     <i class="bi bi-telephone-fill me-1"></i> ${data.phone}
                   </p>`
                : ''
              }
              ${ data.email
                ? `<p class="mb-1 text-muted small">
                     <i class="bi bi-envelope-fill me-1"></i>
                     <a href="mailto:${data.email}" class="text-muted text-decoration-none">${data.email}</a>
                   </p>`
                : ''
              }
              ${ data.telegram_username
                ? `<p class="mb-1 text-muted small">
                     <i class="bi bi-telegram me-1"></i>
                     <a href="https://t.me/${data.telegram_username}" class="text-muted text-decoration-none" target="_blank">@${data.telegram_username}</a>
                   </p>`
                : data.telegram_id
                  ? `<p class="mb-1 text-muted small">
                       <i class="bi bi-telegram me-1"></i> ID: ${data.telegram_id}
                     </p>`
                  : ''
              }
              <small class="text-muted d-block mt-2">
                <i class="bi bi-clock me-1"></i> Створено: ${new Date().toLocaleString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
              </small>
            </div>
          </div>
        </div>
      `;

      contactsList.prepend(newCard);

      const editBtn = newCard.querySelector(".edit-contact-btn");
      if (editBtn) {
        editBtn.addEventListener("click", function() {
          const contactId = data.id.toString();
          editForm.action = `/sales/contacts/edit/${contactId}/`;
          editForm.dataset.contactId = contactId;

          if (formErrors) {
            formErrors.style.display = "none";
            formErrors.innerHTML = "";
          }

          editForm.querySelector("#first_name").value = data.first_name || "";
          editForm.querySelector("#last_name").value = data.last_name || "";
          editForm.querySelector("#position").value = data.position || "";
          editForm.querySelector("#phone").value = data.phone || "";
          editForm.querySelector("#email").value = data.email || "";
          editForm.querySelector("#telegram_username").value = data.telegram_username || "";
          editForm.querySelector("#telegram_id").value = data.telegram_id || "";

          Array.from(companySelect.options).forEach(option => {
            option.selected = (option.dataset.name === data.company_name);
          });
          companySearch.value = data.company_name;

          const modalInstance = new bootstrap.Modal(editModal);
          modalInstance.show();
        });
      }
    }

    // -------- Оновити існуючу картку --------
    function updateExistingCard(data) {
      const card = document.querySelector(`.contact-card[data-contact-id="${data.id}"]`);
      if (!card) {
        console.warn("Не знайдено картку для контакту з id=", data.id, ". Створюємо нову.");
        addNewContactCard(data);
        return;
      }
      card.dataset.name = `${data.first_name} ${data.last_name || ''}`.trim();
      card.dataset.phone = data.phone || '';
      card.dataset.company = data.company_name || '';

      const contactNameEl = card.querySelector(".contact-name");
      if (contactNameEl) {
        contactNameEl.textContent = `${data.first_name} ${data.last_name || ''}`.trim();
      }
      const positionEl = card.querySelector(".text-muted");
      if (positionEl) {
        positionEl.textContent = data.position || "";
      }
      const phoneEl = card.querySelector("p:has(.bi-telephone-fill)");
      if (phoneEl) {
        phoneEl.innerHTML = data.phone
          ? `<i class="bi bi-telephone-fill me-1"></i> ${data.phone}`
          : "";
      }
      const emailEl = card.querySelector("p:has(.bi-envelope-fill) a");
      if (emailEl) {
        if (data.email) {
          emailEl.textContent = data.email;
          emailEl.href = `mailto:${data.email}`;
        } else {
          emailEl.closest("p").innerHTML = "";
        }
      }
      const telegramContainer = card.querySelector("p:has(.bi-telegram)");
      if (telegramContainer) {
        if (data.telegram_username) {
          telegramContainer.innerHTML = `<i class="bi bi-telegram me-1"></i>
            <a href="https://t.me/${data.telegram_username}" class="text-muted text-decoration-none" target="_blank">@${data.telegram_username}</a>`;
        } else if (data.telegram_id) {
          telegramContainer.innerHTML = `<i class="bi bi-telegram me-1"></i> ID: ${data.telegram_id}`;
        } else {
          telegramContainer.innerHTML = "";
        }
      }
      const companyEl = card.querySelector("p:has(.bi-building) a");
      if (companyEl) {
        companyEl.textContent = data.company_name || "";
      }
    }

    // -------- Показати помилки форми --------
    function showFormErrors(error) {
      if (!formErrors) return;
      formErrors.style.display = "block";
      let errorMessages = "<strong>Помилки:</strong><br>";

      try {
        const parsed = typeof error === "string" ? JSON.parse(error) : error;
        if (parsed && typeof parsed === "object") {
          for (const [field, errorList] of Object.entries(parsed)) {
            errorList.forEach(errItem => {
              errorMessages += `<i class="bi bi-exclamation-circle-fill text-danger me-1"></i>
                ${field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}: ${errItem.message || errItem}<br>`;
            });
          }
        } else {
          errorMessages += `<i class="bi bi-exclamation-circle-fill text-danger me-1"></i> ${parsed}<br>`;
        }
      } catch(e) {
        errorMessages += `<i class="bi bi-exclamation-circle-fill text-danger me-1"></i> ${error}<br>`;
      }

      formErrors.innerHTML = errorMessages;
    }

    // Додаємо обробники для початкових кнопок редагування
    addEditButtonListeners();

    // Додаємо обробники для початкової пагінації
    addPaginationListeners(searchInput.value.trim());
  });
</script>
{% endblock %}

